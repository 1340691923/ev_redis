import{f as v,g as V,h as ce,r as z,s as de,o as i,c as p,j as u,t as g,k as B,a as f,w as b,n as J,l as I,u as L,E as _,F as ve,v as pe,b as A,m as X,x as ye,y as w,z as he,p as me,q as _e}from"./index-de26f036.js";import{a as fe,b as ge,c as be}from"./redis-6d2122df.js";import{_ as ke}from"./_plugin-vue_export-helper-c27b6911.js";const $=D=>(me("data-v-e882a576"),D=D(),_e(),D),ze={class:"page-header"},Be={class:"header-left"},we=$(()=>u("h2",null,[u("i",{class:"el-icon-pie-chart"}),w(" 内存分析 ")],-1)),xe={class:"stats-info"},Te={key:0,class:"stat-item"},Se={key:1,class:"stat-item"},Ce={key:2,class:"stat-item"},Me={class:"database-selector"},Ke={key:0,class:"analysis-progress"},Re={class:"progress-info"},De={key:0},Ee={key:1},Ve={key:2,class:"progress-percent"},Ie={class:"progress-details"},Le={key:0},Ae={key:1},$e={key:2},Fe={key:1,class:"analysis-result"},Ne={class:"result-info"},Ge={class:"result-time"},Ue={class:"table-header"},Pe={class:"table-controls"},We=$(()=>u("span",{class:"table-title"},"内存使用分析",-1)),Oe={class:"sort-controls"},Ye=$(()=>u("i",{class:"el-icon-top"},null,-1)),je=$(()=>u("i",{class:"el-icon-bottom"},null,-1)),qe={class:"table-wrapper","element-loading-text":"正在分析内存使用情况..."},Qe={key:0,class:"empty-state"},He={__name:"memory-analysis",setup(D){const r=v(!1),F=v(!1),E=v(""),T=v(""),S=v(""),C=v("size"),M=v("desc");v(600);const N=v({key:"sizeBytes",order:"desc"}),x=v([]),k=v(0),c=v([]),K=v(0),a=v({processed:0,total:0,currentBatch:0,totalBatches:0,estimatedTime:"",startTime:null}),R=v(0),Z=async t=>{try{if(navigator.clipboard&&window.isSecureContext)await navigator.clipboard.writeText(t),_.success("已复制到剪贴板");else{const e=document.createElement("textarea");e.value=t,e.style.position="fixed",e.style.left="-999999px",e.style.top="-999999px",document.body.appendChild(e),e.focus(),e.select();const s=document.execCommand("copy");document.body.removeChild(e),s?_.success("已复制到剪贴板"):_.error("复制失败")}}catch(e){console.error("复制失败:",e),_.error("复制失败")}},y=V(()=>I.sdk.IsMobile()),ee=V(()=>I.sdk.isDarkTheme()),te=V(()=>{const t=[];return t.push({key:"key",title:"Key",dataKey:"key",width:y.value?200:300,sortable:!0,cellRenderer:({rowData:e})=>L("div",{class:"key-cell",title:e.key},[L("span",{class:"key-text"},e.key),L("span",{class:"copy-btn",title:"复制Key",style:{border:"1px solid #409eff",borderRadius:"4px",padding:"2px 6px",cursor:"pointer",color:"#409eff",fontSize:"12px",opacity:"0.7",transition:"opacity 0.2s ease",marginLeft:"8px"},onClick:s=>{s.stopPropagation(),Z(e.key)}},"复制")])}),t.push({key:"size",title:"大小",dataKey:"sizeBytes",width:120,sortable:!0,cellRenderer:({rowData:e})=>L("span",{style:{fontWeight:"500"}},Q(e.sizeBytes||0))}),t}),G=V(()=>{let t=c.value;if(T.value&&T.value.trim()){const e=T.value.trim().toLowerCase();t=t.filter(s=>{const o=s.key.toLowerCase();if(o.includes(e))return!0;if(e.startsWith("size:")){const l=e.substring(5);if(l.startsWith(">")){const n=l.substring(1),h=H(n);return h>0&&s.sizeBytes>h}else if(l.startsWith("<")){const n=l.substring(1),h=H(n);return h>0&&s.sizeBytes<h}}return e.includes("*")?new RegExp(e.replace(/\*/g,".*"),"i").test(o):!1})}if(S.value&&!isNaN(S.value)){const e=parseInt(S.value)*1024;t=t.filter(s=>s.sizeBytes>=e)}return C.value&&M.value&&t.sort((e,s)=>{let o,l;switch(C.value){case"size":o=e.sizeBytes||0,l=s.sizeBytes||0;break;case"key":o=e.key||"",l=s.key||"";break;default:return 0}return M.value==="asc"?o>l?1:o<l?-1:0:o<l?1:o>l?-1:0}),t}),q=async()=>{if(!r.value){r.value=!0,c.value=[],K.value=0,a.value={processed:0,total:0,currentBatch:0,totalBatches:0,estimatedTime:"",startTime:Date.now()};try{const t=I.sdk.GetSelectEsConnID();if(!t){_.error("请先选择Redis连接"),r.value=!1;return}const e=await ge({es_connect:t,database:k.value});if(e.code!==0||!e.data||!e.data.keys){_.warning(e.msg||"未找到任何Keys"),r.value=!1;return}const s=e.data.keys;if(a.value.total=s.length,s.length===0){_.info("数据库中没有Keys"),r.value=!1;return}const o=2e3,l=Math.ceil(s.length/o);a.value.totalBatches=l;for(let n=0;n<s.length&&r.value;n+=o){const h=s.slice(n,n+o);a.value.currentBatch=Math.floor(n/o)+1;try{const d=await be({es_connect:t,database:k.value,keys:h});if(d.code===0&&d.data&&d.data.keyMemoryInfos){if(c.value.push(...d.data.keyMemoryInfos),K.value+=d.data.totalSize||0,a.value.processed+=d.data.processedKeys||h.length,a.value.processed>0){const O=Date.now()-a.value.startTime,Y=a.value.processed/O,j=(s.length-a.value.processed)/Y;a.value.estimatedTime=W(j)}R.value++}}catch(d){if(console.error(`批次 ${a.value.currentBatch} 分析失败:`,d),d.message&&d.message.includes("Redis版本不支持")){_.error("Redis版本不支持MEMORY USAGE命令，请使用Redis 4.0+版本"),r.value=!1;return}}await new Promise(d=>setTimeout(d,50))}if(r.value){const n=Date.now()-a.value.startTime,h=W(n);_.success(`内存分析完成！共分析了 ${c.value.length} 个Keys，耗时 ${h}`)}}catch(t){console.error("内存分析失败:",t),t.message&&t.message.includes("Redis版本不支持")?_.error("Redis版本不支持MEMORY USAGE命令，请使用Redis 4.0+版本"):_.error("内存分析失败: "+(t.message||"未知错误"))}finally{r.value=!1}}},se=()=>{r.value=!1,_.info("已停止内存分析")},ae=()=>{a.value={processed:0,total:0,currentBatch:0,totalBatches:0,estimatedTime:"",startTime:null}},le=()=>{c.value=[],K.value=0,E.value="",T.value="",ae(),R.value++},U=()=>{T.value=E.value,R.value++},P=(t,e)=>{C.value=t,M.value=e,N.value={key:t,order:e},R.value++},oe=t=>{N.value=t,P(t.key,t.order)},Q=t=>{if(!t||t===0)return"0 B";const e=1024,s=["B","KB","MB","GB","TB"],o=Math.floor(Math.log(t)/Math.log(e));return parseFloat((t/Math.pow(e,o)).toFixed(2))+" "+s[o]},W=t=>t<1e3?"< 1秒":t<6e4?Math.round(t/1e3)+"秒":t<36e5?Math.round(t/6e4)+"分钟":Math.round(t/36e5)+"小时",H=t=>{const e=t.match(/^(\d+(?:\.\d+)?)\s*(b|kb|mb|gb|tb)?$/i);if(!e)return 0;const s=parseFloat(e[1]),o=(e[2]||"b").toLowerCase(),l={b:1,kb:1024,mb:1024*1024,gb:1024*1024*1024,tb:1024*1024*1024*1024};return s*(l[o]||1)},ne=async()=>{F.value=!0;try{const t=I.sdk.GetSelectEsConnID();if(!t){_.error("请先选择Redis连接");return}console.log("开始加载数据库列表...");const e=[];for(let o=0;o<=15;o++)e.push({database:o,keys:0,expires:0,avgTTL:0});console.log("默认数据库列表:",e);const s=await fe({es_connect:t});if(console.log("后端返回结果:",s),s.code===0){const o=s.data.databases||[];console.log("后端数据库列表:",o),o.forEach(l=>{if(l.database<=15){const n=e.find(h=>h.database===l.database);n&&(n.keys=l.keys,n.expires=l.expires,n.avgTTL=l.avgTTL)}else e.push(l)}),e.sort((l,n)=>l.database-n.database),console.log("最终数据库列表:",e),x.value=e,(k.value===0||!x.value.find(l=>l.database===k.value))&&(k.value=0),console.log("设置后的数据库列表:",x.value),console.log("选中的数据库:",k.value)}else x.value=e,k.value=0,console.warn("获取数据库列表失败，使用默认数据库列表:",s.msg)}catch(t){console.error("获取数据库列表失败:",t);const e=[];for(let s=0;s<=15;s++)e.push({database:s,keys:0,expires:0,avgTTL:0});x.value=e,k.value=0,_.error("获取数据库列表失败: "+(t.message||"未知错误"))}finally{F.value=!1}};return ce(()=>{ne()}),(t,e)=>{const s=z("el-option"),o=z("el-select"),l=z("el-input"),n=z("el-button"),h=z("el-progress"),d=z("el-card"),O=z("el-button-group"),Y=z("el-empty"),j=z("el-table-v2"),re=z("el-auto-resizer"),ie=de("loading");return i(),p("div",{class:J(["memory-analysis-page",{"mobile-layout":y.value,"dark-mode":ee.value}])},[u("div",ze,[u("div",Be,[we,u("div",xe,[c.value.length>0?(i(),p("span",Te,"Keys: "+g(c.value.length.toLocaleString()),1)):B("",!0),K.value>0?(i(),p("span",Se,"Size: "+g(Q(K.value)),1)):B("",!0),G.value.length!==c.value.length&&c.value.length>0?(i(),p("span",Ce," Filtered: "+g(G.value.length.toLocaleString()),1)):B("",!0)])])]),f(d,{class:"filter-card"},{default:b(()=>[u("div",{class:J(["filter-controls",{"mobile-filters":y.value}])},[u("div",Me,[f(o,{modelValue:k.value,"onUpdate:modelValue":e[0]||(e[0]=m=>k.value=m),placeholder:"选择数据库",size:y.value?"small":"default",style:{width:"150px"},onChange:le,loading:F.value},{default:b(()=>[(i(!0),p(ve,null,pe(x.value,m=>(i(),A(s,{key:m.database,label:`DB${m.database} (${m.keys} keys)`,value:m.database},null,8,["label","value"]))),128))]),_:1},8,["modelValue","size","loading"])]),f(l,{modelValue:E.value,"onUpdate:modelValue":e[1]||(e[1]=m=>E.value=m),placeholder:"搜索Key...","prefix-icon":"el-icon-search",clearable:"",style:X({width:y.value?"200px":"250px"}),size:y.value?"small":"default",onKeyup:ye(U,["enter"]),onClear:U},null,8,["modelValue","style","size"]),f(n,{type:"primary",size:y.value?"small":"default",onClick:U,disabled:c.value.length===0},{default:b(()=>[w(" 搜索 ")]),_:1},8,["size","disabled"]),f(l,{modelValue:S.value,"onUpdate:modelValue":e[2]||(e[2]=m=>S.value=m),placeholder:"最小大小(KB)",clearable:"",type:"number",style:X({width:y.value?"100%":"120px"}),size:y.value?"small":"default"},null,8,["modelValue","style","size"]),f(n,{type:"primary",size:y.value?"small":"default",loading:r.value,onClick:q,disabled:r.value},{default:b(()=>[w(g(r.value?"分析中...":c.value.length>0?"重新分析":"开始内存分析"),1)]),_:1},8,["size","loading","disabled"]),r.value?(i(),A(n,{key:0,type:"danger",size:y.value?"small":"default",onClick:se},{default:b(()=>[w(" 停止分析 ")]),_:1},8,["size"])):B("",!0)],2),r.value||a.value.total>0?(i(),p("div",Ke,[u("div",Re,[a.value.total>0?(i(),p("span",De,"分析进度: "+g(a.value.processed)+" / "+g(a.value.total),1)):(i(),p("span",Ee,"正在获取Keys列表...")),a.value.total>0?(i(),p("span",Ve," ("+g(Math.round(a.value.processed/a.value.total*100))+"%) ",1)):B("",!0)]),f(h,{percentage:a.value.total>0?Math.round(a.value.processed/a.value.total*100):100,status:(r.value,"success"),"stroke-width":8,indeterminate:a.value.total===0},null,8,["percentage","status","indeterminate"]),u("div",Ie,[a.value.totalBatches>0?(i(),p("span",Le," 当前批次: "+g(a.value.currentBatch)+" / "+g(a.value.totalBatches),1)):B("",!0),a.value.estimatedTime?(i(),p("span",Ae," 预计剩余: "+g(a.value.estimatedTime),1)):B("",!0),a.value.total===0?(i(),p("span",$e," 正在获取Keys列表... ")):B("",!0)])])):B("",!0),!r.value&&c.value.length>0&&a.value.startTime?(i(),p("div",Fe,[u("div",Ne,[u("span",null,"分析完成！共分析了 "+g(c.value.length)+" 个Keys",1),u("span",Ge,"耗时: "+g(W(Date.now()-a.value.startTime)),1)])])):B("",!0)]),_:1}),f(d,{class:"table-card"},{default:b(()=>[u("div",Ue,[u("div",Pe,[We,u("div",Oe,[f(O,null,{default:b(()=>[f(n,{type:C.value==="size"&&M.value==="desc"?"primary":"default",onClick:e[3]||(e[3]=m=>P("size","desc"))},{default:b(()=>[Ye,w(" 按大小降序 ")]),_:1},8,["type"]),f(n,{type:C.value==="size"&&M.value==="asc"?"primary":"default",onClick:e[4]||(e[4]=m=>P("size","asc"))},{default:b(()=>[je,w(" 按大小升序 ")]),_:1},8,["type"])]),_:1})])])]),he((i(),p("div",qe,[c.value.length===0&&!r.value?(i(),p("div",Qe,[f(Y,{description:"点击开始分析按钮进行内存分析","image-size":120},{default:b(()=>[f(n,{type:"primary",onClick:q,loading:r.value},{default:b(()=>[w(" 开始内存分析 ")]),_:1},8,["loading"])]),_:1})])):(i(),A(re,{key:1},{default:b(({height:m,width:ue})=>[(i(),A(j,{key:R.value,columns:te.value,data:G.value,width:ue,height:m,"sort-by":N.value,onColumnSort:oe,"row-height":y.value?40:48,"header-height":y.value?40:48,"estimated-row-height":y.value?40:48},null,8,["columns","data","width","height","sort-by","row-height","header-height","estimated-row-height"]))]),_:1}))])),[[ie,r.value&&c.value.length===0]])]),_:1})],2)}}},et=ke(He,[["__scopeId","data-v-e882a576"]]);export{et as default};
